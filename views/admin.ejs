<!DOCTYPE html>
<!-- release v4.1.8, copyright 2014 - 2015 Kartik Visweswaran -->
<html class="slate_gray">
    <head>
        <meta charset="UTF-8"/>
        <title>upload</title>
        <meta name="description" content="app, web app, responsive, admin dashboard, admin, flat, flat ui, ui kit, off screen nav" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <link rel='stylesheet' type='text/css' href='/css/bootstrap.min.css' >
        <link href="css/main.css" rel="stylesheet" type="text/css" />
        <script src="/js/jquery-3.1.1.min.js" type="text/javascript"></script>


        <style>
          .alert{
            position: fixed;
            width: 100%;
            display: none;
          }
          .btn-primary{
            background-color: #303d4a;
            border-color:#303d4a;
          }
          #bt1{
            margin-top: 20px;
            margin-bottom: 20px;
            width: 100%;
            float: right;
          }
          .header__top {
              background: #303d4a;
          }
          .logo {
              display: block;
              background-image: url(../img/content/logo.png);
              background-position: 0px 0px;
              width: 180px;
              height: 32px;
              background-size: 180px, 138px;
              background-repeat: no-repeat;
          }
          .wrap-logo {
              padding-top: 18px;
          }
          .slate_gray {
            background: #f4f7fa;
          }
        </style>
    </head>
    <body>
      <!-- Header -->
      <header id="header" class="header">
          <div class="header__top">
              <div class="container">
                  <div class="row" style="height:70px;">
                      <div class="col-sm-3">
                          <div class="wrap-logo">
                              <a href="/" class="logo"></a>
                          </div>
                      </div>
                      <div class="col-sm-offset-2 col-md-offset-5 col-sm-6 col-md-4 hidden-xs">
                          <div class="col-xs-4 col-sm-5">
                            <p class="userName"></p>
                          </div>
                          <div class="col-xs-6 col-sm-7">
                              <div class="sign">
                                  <a href="./sign"><span>sign</span></a>
                              </div>
                              <div class="logout" style="display:none">
                                  <a href="./logout"><span>logout</span></a>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="wsmenucontent overlapblackbg"></div>
          <div class="wsmenuexpandermain slideRight">
              <a id="navToggle" class="animated-arrow slideLeft">
                  <span></span>
              </a>
          </div>
          <div class="header_down">
              <div class="container">
                  <div class="wrapper clearfix bigmegamenu">
                      <!--Main Menu HTML Code-->
                      <nav class="wsmenu slideLeft clearfix">
                          <ul class="mobile-sub wsmenu-list">
                              <li class="active">
                                  <span class="wsmenu-click"></span>
                                  <a href="/">管理</a>
                              </li>
                              <li>
                                  <span class="wsmenu-click"></span>
                                  <a href="/upload">上传新闻</a>
                              </li>
                          </ul>
                      </nav>
                      <!--Menu HTML Code-->
                  </div>
              </div>
          </div>
      </header>
      <!-- END header -->
        <div class="wrap wrap_white">
          <div class="alert alert-success" role="alert" id='alertBox-success'>Success!</div>
          <div class="alert alert-danger" role="alert" id='alertBox-danger'>Error!</div>
            <div class="container title">
                <h1 class="title__h1 underscore">新闻管理</h1>
            </div>
        </div>
        <!-- END title -->
        <div class="wrap wrap_white pt20">
            <div class="container">
              <div class="container wrap_white">
                  <table class="table table-bordered table-hover">
                    <colgroup>
                      <col style="width:10%">
                      <col style="width:50%">
                      <col style="width:10%">
                      <col style="width:10%">
                      <col style="width:20%">
                    </colgroup>
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>新闻标题</th>
                        <th>分类</th>
                        <th>日期</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id='newstable'>

                    </tbody>
                  </table>
              </div>
            </div>
        </div>
        <!-- END content-->
        <div class="wrap wrap_white">
            <div class="container title">
                <h1 class="title__h1 underscore">用户管理</h1>
            </div>
        </div>
        <div class="wrap wrap_white pt20">
            <div class="container wrap_white">
                <table class="table table-bordered table-hover">
                  <colgroup>
                    <col style="width:10%">
                    <col style="width:30%">
                    <col style="width:30%">
                    <col style="width:30%">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>用户名</th>
                      <th>邮箱</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id='userstable'>

                  </tbody>
                </table>
            </div>
        </div>

        <div class="wrap wrap_white">
            <div class="container title">
                <h1 class="title__h1 underscore">评论管理</h1>
            </div>
        </div>
        <div class="wrap wrap_white pt20">
            <div class="container wrap_white">
                <table class="table table-bordered table-hover">
                  <colgroup>
                    <col style="width:5%">
                    <col style="width:30%">
                    <col style="width:10%">
                    <col style="width:10%">
                    <col style="width:40%">
                    <col style="width:5%">
                  </colgroup>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>新闻标题</th>
                      <th>用户名</th>
                      <th>评论日期</th>
                      <th>内容</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id='commentstable'>

                  </tbody>
                </table>
            </div>
        </div>
    </div>
  <script type="text/javascript">
    var dataset={
      user:<%- JSON.stringify(user) %>,
      users:<%- JSON.stringify(users) %>,
      news:<%- JSON.stringify(news)%>,
      comments:<%- JSON.stringify(comments)%>,
      typelist:<%- JSON.stringify(typeList) %>
    };
  console.debug(dataset);
  </script>
  <script>

    function alertMsg(type,msg){
      let state;
      switch (type) {
        case 'success':
          state='成功'
          break;
        case 'danger':
          state='错误'
          break;
      }
      $('#alertBox-'+type).html(`<b>${state}!  </b>${msg}`).fadeIn('slow/400/fast').delay(2000).fadeOut('slow/400/fast');
    }
    $(document).ready(function() {
      user=dataset.user;
      users=dataset.users;
      news=dataset.news;
      comments=dataset.comments;
      if(!user.null){
        $(".sign").hide();
        $(".logout").show();
        $(".userName").text("hello,"+user.name);
      }
      //render
      let newstable=$("#newstable");
      let userstable=$("#userstable");
      let commentstable=$("#commentstable");
      for (var i = 0; i < news.length; i++) {
        let n=news[i];
        newstable.append(`
          <tr>
            <th>${i+1}</th>
            <td>${n.name}</td>
            <td>${dataset.typelist[parseInt(n.type)-1]}</td>
            <td>${n.time.substring(0,10)}</td>
            <td>
              <button class="btn btn-success preview">预览</button>
              <button class="btn btn-info change">修改</button>
              <button class="btn btn-danger delete">删除</button>
            </td>
          </tr>
          `);
      }
      for (var i = 0; i < users.length; i++) {
        let n=users[i];
        userstable.append(`
          <tr>
            <th>${i+1}</th>
            <td>${n.name}</td>
            <td>${n.email}</td>
            <td>
              <button class="btn btn-danger userdelete">删除</button>
            </td>
          </tr>
          `);
      }
      for (var i = 0; i < comments.length; i++) {
        let n=comments[i];
        commentstable.append(`
          <tr>
            <th>${i+1}</th>
            <td>${n.news}</td>
            <td>${n.user.name}</td>
            <td>${n.time.substring(0,10)}</td>
            <td>${n.content}</td>
            <td>
              <button class="btn btn-danger commentdelete">删除</button>
            </td>
          </tr>
          `);
      }
      //end render
      //button event
      $(".preview").on('click', function(event) {
        let index=$('.preview').index(this);
        location.href='/news?name='+news[index].name;
      });

      $(".change").on('click', function(event) {
        let index=$('.change').index(this);
        $.ajax({
          url: '',
          type: 'POST',
          data: {param1: 'value1'}
        })
        .done(function() {
          console.log("success");
        });
      });

      $(".delete").on('click', function(event) {
        let index=$('.delete').index(this);
        $.ajax({
          url: '/delete',
          type: 'POST',
          data: {
            name: news[index].name,
            type: "news"
          }
        })
        .done(function(res) {
          if(res.state){
            alertMsg('success',res.info);
            setTimeout(function () {
              location.reload();
            },500)
          }else {
            alertMsg('danger',res.info);
          }
        });
      });

      $(".userdelete").on('click', function(event) {
        let index=$('.userdelete').index(this);
        $.ajax({
          url: '/delete',
          type: 'POST',
          data: {
            name: users[index].name,
            type: "user"
          }
        })
        .done(function(res) {
          if(res.state){
            alertMsg('success',res.info);
            setTimeout(function () {
              location.reload();
            },500)
          }else {
            alertMsg('danger',res.info);
          }
        });
      });

      $(".commentdelete").on('click', function(event) {
        let index=$('.commentdelete').index(this);
        $.ajax({
          url: '/delete',
          type: 'POST',
          data: {
            id: comments[index]._id,
            type: "comment"
          }
        })
        .done(function(res) {
          console.debug(res);
          if(res.state){
            alertMsg('success',res.info);
            setTimeout(function () {
              location.reload();
            },500)
          }else {
            alertMsg('danger',res.info);
          }
        });
      });

    });
	</script>
  </body>
</html>
